{% extends 'base.html' %}

{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static 'chat_app/css/style.css' %}">
{% endblock %}

{% block title %}
Chat Room
{% endblock %}

{% block content %}
<div class="container">
	<img src={{ user_to.photo.url }} alt="profile picture" width="60" height="60">
	<h3>{{ user_to.username }}</h3>
</div>

<div id="chat-log" class="chat-log"></div>
<br>

<input id="chat-message-input" type="text" size="50">
<input id="chat-message-submit" type="button" value="Send">

{{ room_name|json_script:"room-name" }}
<script>
	const roomName = JSON.parse(document.getElementById('room-name').textContent);

	let		websocketProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
	let		websocketPort = window.location.protocol === 'https:' ? '' : '';
	const	socketUrl = websocketProtocol + '//' + window.location.host + websocketPort + '/ws/chat/' + roomName + "/";
	const	chatSocket = new WebSocket(socketUrl);

	chatSocket.onmessage = function(e) {
		const data = JSON.parse(e.data);
		const messageContainer = document.createElement('p');
		messageContainer.textContent = data.message;
		messageContainer.className = data.sender === "{{ request.user.username }}" ? 'my-message' : 'other-message';
		document.querySelector('#chat-log').appendChild(messageContainer);
		var chatLog = document.querySelector('.chat-log');
		chatLog.scrollTop = chatLog.scrollHeight;
	};

	chatSocket.onopen = function(e) {
		document.querySelector('#chat-log').innerHTML = '';
	};

	chatSocket.onclose = function(e) {
		console.error('Chat socket closed unexpectedly');
	};

	chatSocket.onerror = function(e) {
		console.error('WebSocket error: ', e);
	};

	document.querySelector('#chat-message-input').focus();
	document.querySelector('#chat-message-input').onkeyup = function(e) {
		if (e.key === 'Enter') {
			document.querySelector('#chat-message-submit').click();
		}
	};

	document.querySelector('#chat-message-submit').onclick = null;
	document.querySelector('#chat-message-submit').onclick = function(e) {
		const messageInputDom = document.querySelector('#chat-message-input');
		const message = messageInputDom.value.trim();
		if (!message)
		  return;
		const sender = "{{ request.user.username }}";
		chatSocket.send(JSON.stringify({
		  'message': message,
		  'sender': sender
		}));
		messageInputDom.value = '';
	};
</script>

{% endblock %}